name: plankifier-experiment

deployment:
  htcondor:
    - kind: central-manager
      labels:
        - central-manager
    - kind: submit
      labels:
        - submit
    - kind: execute
      labels:
        - execute-cloud
    - kind: execute
      labels:
        - execute-edge
      config-file: config/execute.conf

sites:
  - kind: chameleon-edge
    walltime: "04:00:00"
    lease_name: edge-lease
    rc_file: secrets/edge-app-cred-oac-edge-openrc.sh
    resources:
      machines:
        - labels:
            - execute-edge
          machine_name: raspberrypi4-64
          count: 1
          container:
            name: execute
            image: pegasus/plankifier

  - kind: chameleon
    walltime: "04:00:00"
    lease_name: tacc-lease
    rc_file: secrets/tacc-app-cred-oac-edge-openrc.sh
    key_name: mayani-mac-mini
    image: CC-Ubuntu18.04
    resources:
      machines:
        - labels:
            - central-manager
            - submit
            - execute-cloud
          flavour: compute_zen3
          number: 1
          image: CC-Ubuntu22.04
      networks:
        - sharednet1

experiments:
  - kind: pegasus
    name: plankifier-experiment
    count: 1
    main: ./workflow.py
    submit_node_labels:
      - submit
    inputs:
      - labels:
          - execute-edge
        src: bin/train.py
        dst: /srv/plankifier/
      - labels:
          - execute-edge
        src: bin/predict.py
        dst: /srv/plankifier/
    setup:
      - labels:
          - submit
        script: |
          chmod +x workflow.py
      - labels:
          - execute-edge
        script: |
          chmod +x /srv/plankifier/train.py /srv/plankifier/predict.py
    outputs:
      - labels:
          - submit
        src: ~kiso/kiso-plankifier-experiment/output/count.txt
        dst: ./
